<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Highlight.js Theme CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">

    <!-- highlight.js script (fixed path) -->
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>

    <!-- marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&family=Crimson+Pro&display=swap" rel="stylesheet">
    
    <title>CodeHelp AI Chat</title>
    <style>
        body {
            font-family: 'Crimson Pro', serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(180deg, #1f261f, #141a14);
            color: #ddd;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-top: 0;
        }
        .message {
            margin: 0.5rem 0;
            padding: 0.7rem 0.5rem;
            border-radius: 8px;
            max-width: 80%;
            width: fit-content;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 15px;
        }

        .message * {
            margin: 0;
            padding: 0;
        }

        .message p {
            margin: 0;
            padding: 0;
            line-height: 1.4;
            display: inline;
        }

        .message ul,
        .message ol {
            padding-left: 1.2em;
            margin: 0.4em 0;
            list-style-position: inside;
        }

        .message li {
            margin-bottom: 0.3em;
        }

        .user {
            background-color: #2c4c3a;
            border: 1px solid #40644c;
            font-family: 'Crimson Pro', serif;
            align-self: flex-end;
            text-align: left;
            margin-left: auto;
        }
        .assistant {
            background-color: #2a3028;
            border: 1px solid #444e44;
            font-family: 'Crimson Pro', serif;
            color: #e1dfd2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        #input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #444;
            align-items: flex-end;
        }
        #userInput {
            flex: 1;
            padding: 0.8rem;
            border-radius: 10px;
            border: 1px solid #444f44;
            outline: none;
            background: #242c22;
            color: #e8e3d8;
            resize: none; /* prevent manual resizing */
            overflow-y: auto;
            min-height: 40px;
            max-height: 200px; /* optional limit */
            box-sizing: border-box;
            box-shadow: inset 0 0 3px #000;
        }
        #action-buttons button {
            background: #3a4a34;
            font-family: 'Cinzel Decorative', serif;
            color: #e2dbc7;
            border: 1px solid #5b6d55;
            box-shadow: inset 0 0 2px #222;
            text-shadow: 0 1px 1px #000;
            transition: background 0.3s;
        }

        #action-buttons button:hover {
            background: #4f6248;
        }

        #input-area button {
            background: #5c6f57;
            font-family: 'Crimson Pro', serif;
            color: #fffde9;
            border-radius: 6px;
            border: 1px solid #7c8f72;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            cursor: pointer;
            transition: background 0.3s;
            height: 58.2px;
            margin-bottom: 0;
        }

        #input-area button:hover {
            background: #6e8465;
        }

        button:hover {
            background: #6e8465;
        }

        #header {
            height: 500px;
            padding: 2rem 0 1rem 0;
            margin: 0 -1rem;
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            font-size: 20px;
            background: linear-gradient(180deg, #2b332b, #1a201a);
            color: #e2dbc7;
            border-bottom: 1px solid #3f4f3f;
        }

        #headerLabel {
                font-size: 28px;
                font-family: cursive;
        }

        #header img {
            position: relative;
            z-index: 1;
            animation: shimmer 4s linear infinite;
            filter: drop-shadow(0 0 6px #2fd07466);
        }

        @keyframes shimmer {
            0% {
                opacity: 0.85;
                filter: drop-shadow(0 0 2px #2fd07466);
            }
            50% {
                opacity: 1;
                filter: drop-shadow(0 0 8px #2fd074cc);
            }
            100% {
                opacity: 0.85;
                filter: drop-shadow(0 0 2px #2fd07466);
            }
        }

        #headerQuote {
            font-size: 16px;
            font-style: italic;
            margin-top: 0.3rem;
            color: #b9ccb7;
            opacity: 0.85;
            animation: fadeInQuote 3s ease-in;
        }

        @keyframes fadeInQuote {
            from {
                opacity: 0;
                /* transform: translateY(10px); */
            }
            to {
                opacity: 0.85;
                /* transform: translateY(0); */
            }
        }

        #header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('{{headerBg}}') center/contain no-repeat;
            opacity: 0.1;
            z-index: 0;
            pointer-events: none;
        }
        #header {
            position: relative;
            z-index: 1;
        }

    </style>
</head>
<body>
    <div id="chat">
        <div id="header">
            <div>
                <img src="{{headerIcon}}" height="270px" alt="icon">
            </div>
            <div id="headerLabel">Master Ruwan</div>
            <div id="headerQuote"></div>
        </div>
    </div>
    <div id="action-buttons" style="display: flex; gap: 0.5rem; padding: 0.5rem 1rem; border-top: 1px solid #444; border-bottom: 1px solid #444;">
        <button onclick="runAction('fix')">üõ† Fix Code</button>
        <button onclick="runAction('explain')">üí° Explain Code</button>
        <button onclick="runAction('refactor')">üß† Refactor Code</button>
        <button onclick="runAction('comment')">üìù Add Comments</button>
    </div>
    <div id="input-area">
        <textarea  type="text" id="userInput" placeholder="Ask something..." /></textarea>
        <button onclick="send()">Send</button>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const chat = document.getElementById('chat');
        const input = document.getElementById('userInput');

        input.addEventListener('input', () => {
            input.style.height = 'auto'; // reset height to shrink if needed
            const newHeight = Math.min(input.scrollHeight, 200);
            input.style.height = newHeight + 'px';
        });

        marked.setOptions({
            highlight: function(code, lang) {
                const validLang = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language: validLang }).value;
            }
        });

        function appendMessage(text, role) {
            const div = document.createElement('div');
            div.className = 'message ' + role;
            div.innerHTML = marked.parse(text);
            console.log(div.innerHTML)

            chat.appendChild(div);

            // Highlight code blocks
            div.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            
            div.querySelectorAll('pre').forEach(pre => {
                const button = document.createElement('button');
                button.textContent = 'üìã';
                button.style.cssText = "position: absolute; top: 5px; right: 10px; background: #007acc; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 12px; ";

                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';

                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(pre);
                wrapper.appendChild(button);

                button.onclick = () => {
                    navigator.clipboard.writeText(pre.innerText).then(() => {
                        button.textContent = '‚úÖ';
                        setTimeout(() => (button.textContent = 'üìã'), 1500);
                    });
                };
            });

            chat.scrollTop = chat.scrollHeight;
        }

        function appendThinking() {
            const existing = document.getElementById('thinking');
            if (existing) return; // don't add multiple

            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = 'thinking';
            div.textContent = 'Thinking... ü§î';
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        
        function removeThinking() {
            const thinking = document.getElementById('thinking');
            if (thinking) {
                chat.removeChild(thinking);
            }
        }

        function send() {
            const text = input.value.trim();
            if (!text) return;

            appendMessage(text, 'user');

            // document.getElementById('response').innerText = "Thinking... ü§î";
            appendThinking();
            vscode.postMessage({ type: 'prompt', value: text  });
            input.value = '';
        }

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // prevent newline
                send();
            }
        });

        window.addEventListener('message', event => {
            const message = event.data;
            if (message.type === 'response') {
                removeThinking();
                appendMessage(message.value, message.role || 'assistant');
            }
        });

        const quotes = [
            "‚ÄúIn stillness, the answer roots itself.‚Äù",
            "‚ÄúLet the code breathe, and it will speak.‚Äù",
            "‚ÄúThe compiler judges not your haste, but your clarity.‚Äù",
            "‚ÄúNo great forest was mapped in one sitting.‚Äù",
            "‚ÄúNature does not debug. It evolves.‚Äù",
            "‚ÄúEvery loop, like every path, must return or end.‚Äù",
            "‚ÄúWhat you understand, you do not fear to refactor.‚Äù"
        ];

        function setRandomQuote() {
            const quoteEl = document.getElementById("headerQuote");
            const index = Math.floor(Math.random() * quotes.length);
            quoteEl.textContent = quotes[index];
        }

        setRandomQuote();

        function runAction(action) {
            vscode.postMessage({ type: 'action', value: action });
        }

    </script>
</body>
</html>